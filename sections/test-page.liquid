<section class="md:x-py-[30px] md:x-pt-[90px]">
  <div class="x-flex x-flex-col md:x-flex-row md:x-px-[50px] md:x-gap-[50px] x-h-auto md:x-h-[540px] lg:x-h-full lg:x-max-w-[1440px] lg:x-mx-auto">
    <div class="md:x-w-1/2 lg:x-w-2/3">
      <div class="x-flex x-flex-col md:x-flex-row-reverse x-justify-end md:x-gap-[20px]">
        <div class="md:x-flex-1">
          <div
            class="carousel-main x-p-[16px] x-pb-[10px] md:x-p-[0px] md:x-w-[100%] x-h-auto x-shadow-none"
            data-flickity='{ "fade": true }'
          >
            <div class="carousel-cell">highlight image 1</div>
            <div class="carousel-cell">highlight image 2</div>
            <div class="carousel-cell">highlight image 3</div>
            <div class="carousel-cell">highlight image 4</div>
            <div class="carousel-cell">highlight image 5</div>
            <div class="carousel-cell">highlight image 6</div>
            <div class="carousel-cell">highlight image 7</div>
            <div class="carousel-cell">highlight image 8</div>
          </div>
        </div>
        <div
          class="carousel-nav x-hidden md:x-flex x-flex-col x-gap-[10px] md:x-gap-[20px] x-overflow-y-scroll x-px-[16px] md:x-p-[0px] no-scrollbar x-snap-y x-snap-mandatory md:x-h-[540px]"
        >
          <div class="thumbnail">
            <div class="image">thumbnail 1</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 2</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 3</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 4</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 5</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 6</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 7</div>
            <div class="highlight"></div>
          </div>
          <div class="thumbnail">
            <div class="image">thumbnail 8</div>
            <div class="highlight"></div>
          </div>
        </div>
      </div>

      <div class="md:x-hidden x-block">
        <div
          class="carousel-nav x-flex x-flex-row x-gap-[10px] x-overflow-x-scroll x-px-[16px] no-scrollbar x-snap-x x-snap-mandatory x-scroll-pl-[16px]"
        >
          {% for variant in product.variants %}
            {% if variant.selected %}
              {% assign variantImages = variant.metafields.custom.img_src.value %}

              <div class="x-mr-[10px] thumbnail">
                <img
                  src="{{ variant.featured_image | image_url: width: '1000', height: '1000' }}"
                  alt="Variant Primary Image"
                  width="75px"
                  height="75px"
                >
              </div>
              <!-- Add additional variant image URLs -->
              {% if variantImages %}
                {% for url in variantImages %}
                  <div class="x-mr-[10px] thumbnail">
                    <img src="{{ url }}" alt="Thumbnail Image" width="75px" height="75px">
                  </div>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="x-px-[16px] x-py-[36px] md:x-p-[0px] md:x-flex md:x-justify-center md:x-items-start md:x-w-1/2 lg:x-w-1/3">
      <div class="x-flex x-flex-col x-gap-[32px] md:x-w-[420px] md:x-sticky md:x-top-[120px]">
        <div class="x-flex x-flex-col x-gap-[20px]">
          <div class="x-flex x-flex-col x-gap-[6px]">
            <div class="x-text-[24px] x-uppercase">{{ product.title }}</div>
            <div>reviews</div>
          </div>
          <div class="x-flex x-flex-col x-gap-[6px]">
            <div id="variant-price" class="x-text-[20px]"></div>
            <div id="variant-name" class="x-text-[16px] x-uppercase"></div>
          </div>
        </div>
        <div>
          <div class="x-text-[14px] x-leading-[20px]">
            {{ product.description }}
          </div>
        </div>
        <div>
          <div class="x-text-[14px]">{{ product.options[0] }}:</div>
        </div>
        <div class="x-flex x-flex-col x-gap-[20px]">
          <div id="variant-buttons" class="x-flex x-flex-row x-gap-[16px]">
            {% if product.variants.size > 1 %}
              {% for variant in product.variants %}
                <label>
                  <input
                    type="radio"
                    name="square-color"
                    class="swatch-input__hidden"
                    data-id="{{ variant.id }}"
                    data-price="{{ variant.price | money }}"
                    data-variant-desc="{{ variant.metafields.custom.variant_desc.value }}"
                    data-thumbnails="{{ variant.metafields.custom.img_src.value | join: ', ' }}"
                    data-url="{{ variant.featured_image | image_url: width: '1000', height: '1000' }}"
                    data-name="{{ variant.title }}"
                    {% if forloop.first %}
                      checked
                    {% endif %}
                  >
                  <div
                    class="swatch-variant"
                    style="background-color: {{ variant.metafields.custom.color_hexcode }};"
                  >
                    &nbsp;
                  </div>
                </label>
              {% endfor %}
            {% endif %}
          </div>
          <div>
            <div class="x-inline-block">
              <div
                class="quantity-picker x-flex x-border-[1px] x-border-gray-300 x-gap-[12px] x-items-center x-justify-between"
              >
                <button
                  class="x-text-gray-500 x-text-[18px] x-flex x-items-center x-justify-center x-p-[16px] x-pointer-events-none"
                  id="decrease"
                >
                  <i class="bx bx-minus" disabled="true"></i>
                </button>
                <input
                  type="text"
                  disabled="true"
                  id="quantity"
                  value="1"
                  readonly
                  class="x-text-center x-w-[30px] x-bg-transparent x-border-none x-outline-none"
                >
                <button
                  class="x-text-gray-500 x-text-[18px] x-flex x-items-center x-justify-center x-p-[16px]"
                  id="increase"
                >
                  <i class="bx bx-plus"></i>
                </button>
              </div>
            </div>
          </div>
          <button
            class="x-w-full x-h-[55px] x-uppercase x-text-[10px] x-text-center x-text-white x-bg-green-950"
          >
            Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  $(document).ready(function () {
    setFirstOptionSelected();
    bindVariantButtonClick();
    // Initialize main carousel
    var $mainCarousel = $('.carousel-main').flickity({});

    // on load
    $('.carousel-nav .thumbnail')[0].classList.add('is-nav-selected');
    $("#variant-buttons input[type='radio']:checked").trigger('click');

    $mainCarousel.on('change.flickity', function (event, index) {
      // Remove 'is-nav-selected' from all thumbnails
      $('.carousel-nav .thumbnail').removeClass('is-nav-selected');

      // Add 'is-nav-selected' to the current thumbnail
      $('.carousel-nav .thumbnail')[index].classList.add('is-nav-selected');
      console.log(index); // For debugging
    });

    // Thumbnail click event to change the main carousel
    $('.carousel-nav .thumbnail').on('click', function () {
      let index = $(this).index();
      $mainCarousel.flickity('select', index);
    });
  });

  function setFirstOptionSelected() {
    const urlParams = new URLSearchParams(window.location.search);
    let variantId = urlParams.get('variant');
    if (variantId) {
      let $button = $("#variant-buttons input[type='radio'][data-id='" + variantId + "']");
      if ($button.length) {
        $button.prop('checked', true);
      } else {
        $("#variant-buttons input[type='radio']").first().prop('checked', true);
      }
    } else {
      let defaultVariantId = $("#variant-buttons input[type='radio']").first().data('id');
      updateUrl(defaultVariantId);
      $("#variant-buttons input[type='radio']").first().prop('checked', true);
    }
  }

  function bindVariantButtonClick() {
    $("#variant-buttons input[type='radio']").on('click', function () {
      let $button = $(this);
      let variantId = $button.data('id');
      let price = $button.data('price');
      let variantDesc = $button.data('variant-desc');
      let imageUrl = $button.data('url');
      let thumbnails = $button.data('thumbnails').split(', ');
      let variantName = $button.data('name');
      console.log('Thumbnails:', thumbnails); // Add this line to check what URLs are coming through
      console.log('Variant Featured Image URL:', imageUrl);

      thumbnails.unshift(imageUrl);
      handleVariantSelection(variantId, price, variantDesc, imageUrl, thumbnails, variantName);
    });
  }

  function handleVariantSelection(variantId, price, variantDesc, imageUrl, thumbnails, variantName) {
    updateUrl(variantId);
    updateThumbnails(thumbnails);
    updateVariantDetails(variantDesc, price, variantName);
  }

  function updateVariantDetails(variantDesc, price, variantName) {
    $('#variant-description').text(variantDesc);
    $('#variant-price').text(price);
    $('#variant-name').text(variantName);
  }

  function updateUrl(variantId) {
    // Check if variantId is not empty
    if (variantId) {
      let newUrl = window.location.href.split('?')[0] + '?variant=' + variantId;
      window.history.replaceState({ path: newUrl }, '', newUrl);
    }
  }

  function updateThumbnails(thumbnails) {
    const $thumbnailContainer = $('.carousel-nav');
    $thumbnailContainer.empty(); // Clear existing thumbnails

    thumbnails.forEach((thumbnailUrl, index) => {
      const thumbnailHtml = `
            <div class="thumbnail">
                <div class="image">
                    <img src="${thumbnailUrl}" alt="Thumbnail Image ${index + 1}" width="75" height="75">
                </div>
                <div class="highlight"></div>
            </div>
        `;
      $thumbnailContainer.append(thumbnailHtml);
    });

    // Make sure the first thumbnail is selected
    if ($('.carousel-nav .thumbnail').length > 0) {
      $('.carousel-nav .thumbnail').first().addClass('is-nav-selected');
    }
  }

  function addToCart(variantId) {
    const quantity = parseInt($('#quantity').val());
    $.ajax({
      url: '/cart/add.js',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ id: variantId, quantity: quantity }),
      success: function (data) {
        console.log('Product added to cart:', data);
        resetQuantityCounter();
      },
      error: function (error) {
        console.error('Error adding to cart:', error);
      },
    });
  }

  function resetQuantityCounter() {
    $('#quantity').val(1);
  }
</script>

<style>
  .carousel-cell {
    background: #8c8;
    color: white;
    width: 100%;
    height: 425px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s ease;
  }

  .carousel-nav .thumbnail.is-nav-selected > .highlight {
    opacity: 1;
  }

  .thumbnail {
    cursor: pointer;
    display: flex;
    flex-direction: column;
    scroll-snap-align: start;
    cursor: grab;
  }

  .thumbnail > .image {
    background: #8c8;
    color: white;
    max-width: 75px;
    min-width: 75px;
    min-height: 75px;
  }

  .thumbnail > .highlight {
    background: rgb(63, 63, 63);
    margin-top: 10px;
    height: 2px;
    width: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .carousel-main .flickity-page-dots {
    display: none;
  }

  .carousel-main .flickity-button {
    display: none;
  }

  .swatch-input__hidden {
    display: none;
  }

  .swatch-variant {
    width: 32px;
    height: 32px;
    border-radius: 100%;
    border: 2px solid white;
    transition: box-shadow 0.2s;
  }

  input:checked + .swatch-variant {
    box-shadow: 0 0 0 1px gray;
  }

  @media (min-width: 990px) {
    .carousel-main {
      width: 100%;
      aspect-ratio: 1;
    }

    .carousel-cell {
      height: 100%;
      width: 100%;
    }

    .thumbnail > .highlight {
      margin-top: 0px;
      margin-right: 10px;
      height: 50%;
      width: 2px;
    }

    .thumbnail {
      display: flex;
      flex-direction: row-reverse;
      align-items: center;
    }
  }
</style>

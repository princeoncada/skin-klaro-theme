<script src="{{ 'custom-product-page.js'| asset_url }}" defer></script>

<section>
    <!-- Main image display (this will update based on the selected thumbnail) -->
    <div class="main-carousel x-p-[16px] x-pb-[10px]">
        <!-- Default main image; will be updated on thumbnail selection -->
        {% for variant in product.variants %}
            {% if variant.selected %}
                <div class="carousel-cell">
                    <img id="main-image" src="{{ variant.featured_image | image_url: width: '1000', height: '1000' }}"
                        alt="Main Image" width="100%" height="100%">
                </div>
                {% for url in variant.metafields.custom.img_src.value %}
                    <div class="carousel-cell">
                        <img src="{{ url }}" alt="Main Image Variant" width="100%" height="100%">
                    </div>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </div>

    <!-- Thumbnails carousel -->
    <div class="thumbnail-carousel x-shadow-none x-ml-[16px]">
        {% for variant in product.variants %}
            {% if variant.selected %}
                <!-- First thumbnail (main image) -->
                <div class="x-mr-[10px] thumbnail">
                    <img src="{{ variant.featured_image | image_url: width: '1000', height: '1000' }}" alt="Thumbnail"
                        width="75px" height="75px">
                </div>
                <!-- Additional thumbnails for the variant -->
                {% for url in variant.metafields.custom.img_src.value %}
                    <div class="x-mr-[10px] thumbnail">
                        <img src="{{ url }}" alt="Thumbnail Image" width="75px" height="75px">
                    </div>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </div>

    <div class="x-p-[16px]">
        <div class="x-py-[25px]">
            <div>
                <div>{{ product.title }}</div>
                <div>reviews</div>
            </div>
            <div>
                <div id="variant-price"></div>
                <div>
                    <div>some content</div>
                    <div class="">{{ product.description }}</div>
                    <div id="variant-description"></div>
                </div>
            </div>
            <div>
                <div id="variant-buttons" class="x-flex x-gap-4 x-justify-start">
                    {% for variant in product.variants %}
                        <button
                            class="variant-button {% if forloop.first %} active {% endif %} x-flex x-items-center x-justify-center x-rounded-full x-w-auto x-h-auto x-border-2"
                            style="border-color: {{ variant.metafields.custom.color_hexcode }};" data-id="{{ variant.id }}"
                            data-price="{{ variant.price | money }}"
                            data-variant-desc="{{ variant.metafields.custom.variant_desc.value }}"
                            data-thumbnails="{{ variant.metafields.custom.img_src.value | join: ', ' }}"
                            data-url="{{ variant.featured_image | image_url: width: '1000', height: '1000' }}">
                            <span class="inner-circle x-block x-rounded-full x-w-[32px] x-h-[32px]"
                                style="background-color: {{ variant.metafields.custom.color_hexcode }};">
                            </span>
                        </button>
                    {% endfor %}
                </div>
                <!-- Quantity Selector -->
                <div class="x-w-full x-mb-4 x-text-center">
                    <button id="decreaseQty"
                        class="x-text-xl x-font-bold x-px-4 x-py-2 x-bg-gray-300 x-rounded">-</button>
                    <input id="quantityInput" type="number" value="1" min="1"
                        class="x-w-12 x-text-center x-border-none x-bg-transparent x-outline-none x-text-black"
                        readonly>
                    <button id="increaseQty"
                        class="x-text-xl x-font-bold x-px-4 x-py-2 x-bg-gray-300 x-rounded">+</button>
                </div>
                <!-- Add to cart Selector -->
                <div class="x-w-full x-mb-4 x-text-center">
                    <button id="checkoutButton"
                        class="x-text-xl x-font-bold x-py-2 x-px-4 x-text-black x-border x-border-black x-bg-transparent x-rounded-none">
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    $(document).ready(function () {
        initializeFlickity();
        setFirstOptionSelected();

        $("#variant-buttons .variant-button").on('click', function () {
            let $button = $(this);
            let selection = $button.data('id');
            let imageUrl = $button.data('url');
            let price = $button.data('price');
            let variantDesc = $button.data('variant-desc');
            let thumbnailUrls = $button.data('thumbnails').split(', ');

            updateUrl(selection);
            changeThumbnail(imageUrl);
            changeMainImage(imageUrl);
            setThumbnails([imageUrl, ...thumbnailUrls]);

            $('#variant-description').text(variantDesc);
            $('#variant-price').text(price);

            $("#variant-buttons .variant-button").removeClass('active');
            $button.addClass('active');
        });

        $("#variant-buttons .variant-button.active").trigger('click');

        $('#decreaseQty').click(function () {
            let currentValue = parseInt($('#quantityInput').val());
            if (currentValue > 1) {
                $('#quantityInput').val(currentValue - 1);
            }
        });

        $('#increaseQty').click(function () {
            let currentValue = parseInt($('#quantityInput').val());
            $('#quantityInput').val(currentValue + 1);
        });

        $('#checkoutButton').click(function () {
            let productId = $("#variant-buttons .variant-button.active").data('id');
            addToCart(productId);
        });

    });

    function addToCart(productId) {
        const checkoutButton = $('#checkoutButton');
        const quantity = parseInt($('#quantityInput').val()); // Use the selected quantity
        if (!checkoutButton.prop('disabled')) {
            $.ajax({
                url: '/cart/add.js',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: productId, quantity: quantity }), // Pass the selected quantity here
                success: function (data) {
                    console.log('Product added to cart:', data);
                    resetQuantityCounter();
                },
                error: function (error) {
                    console.error('Error adding to cart:', error);
                }
            });
        } else {
            alert('The selected variant is out of stock.');
        }
    }

    function resetQuantityCounter() {
        $('#quantityInput').val(1);
    }

    function setThumbnails(thumbnailUrls) {
        let $carousel = $(".thumbnail-carousel").flickity({
            initialIndex: 0,
            cellAlign: 'left',
            contain: true
        });
        let allCurrentThumbnails = $('.thumbnail');
        $carousel.flickity('remove', allCurrentThumbnails);
        thumbnailUrls.forEach(url => {
            let $thumbnail = $('<div class="x-mr-[10px] thumbnail"><img src="' + url + '" alt="" width="75px" height="75px"></div>');

            //PARA MAG CHANGE ANG FREAKING MAIN IMAGE.
            $thumbnail.on('click', function () {
                changeThumbnail(url); // Update the main image when the thumbnail is clicked
                $('.thumbnail-carousel').flickity('selectCell', index); // Sync thumbnail to the clicked one
                $('#featured-image').flickity('select', index); // Sync main image carousel to the clicked thumbnail
            });
            $carousel.flickity('append', $thumbnail);
        });
    }

    function changeMainImage(imgUrl) {
        $("#main-image").attr('src', imgUrl);
    }

    function changeThumbnail(imgUrl) {
        $("#main-image").attr('src', imgUrl);
        $(".featured-image-thumbnail img").attr('src', imgUrl);
    }

    function setFirstOptionSelected() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('variant')) {
            let variantId = urlParams.get('variant');
            let $button = $("#variant-buttons .variant-button[data-id='" + variantId + "']");
            if ($button.length) {
                $button.addClass('active');
            } else {
                $("#variant-buttons .variant-button").first().addClass('active');
            }
        } else {
            updateUrl({{ product.variants.first.id }});
        $("#variant-buttons .variant-button").first().addClass('active');
    }
    }

    function updateUrl(variantId) {
        let newUrl = window.location.href.split('?')[0] + '?variant=' + variantId;
        window.history.pushState({ path: newUrl }, '', newUrl);
    }

    function initializeFlickity() {
        // Thumbnail Carousel
        let $thumbnailCarousel = $(".thumbnail-carousel").flickity({
            cellAlign: 'left',
            contain: true,
            pageDots: false,
            prevNextButtons: false,
            draggable: true,
           // asNavFor: '.main-carousel'
        });

        // Main image carousel
        let $mainCarousel = $(".main-carousel").flickity({
            cellAlign: 'center',
            contain: true,
            pageDots: false,
        //    wrapAround: true,
            draggable: true,
            prevNextButtons: true,
             asNavFor: '.thumbnail-carousel'
        });

        // Main image swipe
        $thumbnailCarousel.on('select.flickity', function (event, index) {
            let flkty = $thumbnailCarousel.data('flickity');
            let selectedThumbnail = flkty.selectedElement.querySelector('img').src;
            changeMainImage(selectedThumbnail);
        });

        // Thumbnail Change
        $('.thumbnail img').on('click', function () {
            let imgSrc = $(this).attr('src');
            changeMainImage(imgSrc);
        });
    }

</script>

<style>
    .carousel-cell {
        width: 100%;
    }

    .thumbnail-carousel>button,
    .thumbnail-carousel>.flickity-page-dots {
        display: none;
    }

    .variant-button {
        transition: all 0.3s ease;
    }

    .inner-circle {
        transition: all 0.3s ease;
    }

    .variant-button.active .inner-circle {
        border: 4px solid white;
    }
</style>
<div class="x-container x-p-4">
  <div class="x-flex x-flex-col x-items-center">
    <!-- Main Product Image -->
    <div class="x-w-full x-h-auto x-mb-4">
      <img id="mainImage" src="{{ product.media.first.preview_image | image_url: width: 1000 }}" alt="{{ product.title }}" class="x-w-full x-h-auto" loading="lazy" sizes="100vw" />
    </div>
  </div>

  <!-- Radio Button Variant Selector -->
  <div class="x-w-full x-mb-4">
    <div class="x-flex x-gap-4 x-justify-center">
      {% for variant in product.variants %}
        <button class="variant-button {% if forloop.first %} active {% endif %}" 
                data-main-img="{{ variant.image | image_url: width: 1000 }}"
                data-img-src="{{ variant.metafields.custom.img_src | replace: '[', '' | replace: ']', '' | replace: '"', '' }}"
                onclick="changeVariant(this)">
          {{ variant.title }}
        </button>
      {% endfor %}
    </div>
  </div>

  <!-- Variant Images with Horizontal Scrolling and Snap -->
  <div class="x-overflow-x-auto x-w-full x-snap-x x-snap-mandatory x-flex x-gap-4 x-pb-4" id="variantImagesContainer">
    <div id="thumbnailMainImage" class="x-w-20 x-h-20 x-snap-center x-relative thumbnail-item active">
      <img src="{{ product.media.first.preview_image | image_url: width: 1000 }}" alt="Main Product Image" class="x-cursor-pointer x-object-cover x-w-full x-h-full"
           onclick="changeImage('{{ product.media.first.preview_image | image_url: width: 1000 }}')" />
      <div class="thumbnail-marker"></div>
    </div>

  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const firstVariantButton = document.querySelector('.variant-button.active');
    if (firstVariantButton) {
      changeVariant(firstVariantButton);
    }
  });

  function changeImage(imageUrl) {
    const mainImage = document.getElementById('mainImage');
    fadeOut(mainImage, function() {
      mainImage.src = imageUrl;
      fadeIn(mainImage);
    });
  }

  function changeVariant(button) {
    const buttons = document.querySelectorAll('.variant-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');

    const mainImageUrl = button.getAttribute('data-main-img');
    const variantImages = button.getAttribute('data-img-src');

    changeImage(mainImageUrl);

    const variantImagesContainer = document.getElementById('variantImagesContainer');
    variantImagesContainer.innerHTML = ''; 

    const mainThumbnail = document.createElement('div');
    mainThumbnail.className = 'x-w-20 x-h-20 x-snap-center x-relative thumbnail-item active';
    mainThumbnail.innerHTML = `
      <img src="${mainImageUrl}" alt="Main Product Image" class="x-cursor-pointer x-object-cover x-w-full x-h-full"
           onclick="changeImage('${mainImageUrl}')">
      <div class="thumbnail-marker"></div>
    `;
    variantImagesContainer.appendChild(mainThumbnail);

    {% comment %} Inject new variant images {% endcomment %}
    if (variantImages) {
      const variantImagesArray = variantImages.split(',');
      variantImagesArray.forEach(function(imageUrl) {
        const imageThumbnail = document.createElement('div');
        imageThumbnail.className = 'x-w-20 x-h-20 x-snap-center x-relative thumbnail-item';
        imageThumbnail.innerHTML = `
          <img src="${imageUrl.trim()}" alt="Variant Image" class="x-cursor-pointer x-object-cover x-w-full x-h-full"
               onclick="changeImage('${imageUrl.trim()}')">
          <div class="thumbnail-marker"></div>
        `;
        variantImagesContainer.appendChild(imageThumbnail);
      });

       {% comment %} Add the marker to the first variant thumbnail by default {% endcomment %}
      const firstThumbnail = variantImagesContainer.querySelector('.thumbnail-item');
      if (firstThumbnail) {
        firstThumbnail.classList.add('active');
      }
    }
  }

  {% comment %} Image Effects  {% endcomment %}
  function fadeOut(element, callback) {
    element.style.opacity = 1;
    (function fade() {
      if ((element.style.opacity -= 0.1) < 0) {
        element.style.display = "none";
        if (callback) callback();
      } else {
        requestAnimationFrame(fade);
      }
    })();
  }

  function fadeIn(element) {
    element.style.opacity = 0;
    element.style.display = "block";
    (function fade() {
      let val = parseFloat(element.style.opacity);
      if (!((val += 0.1) > 1)) {
        element.style.opacity = val;
        requestAnimationFrame(fade);
      }
    })();
  }
</script>

<!-- Styles -->
<style>
  /* Variant Button Styles */
  .variant-button {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid #ddd;
    background-color: white;
    transition: all 0.3s ease;
  }

  .variant-button.active {
    background-color: hsl(261deg 80% 48%);
    color: white;
    border-color: hsl(261deg 80% 48%);
  }

  .variant-button:hover {
    background-color: hsl(261deg 80% 48%);
    color: white;
  }

  /* Marker under the active thumbnail - ambot ngano di mugana bug ni*/
  .thumbnail-marker {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background-color: blue;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .thumbnail-item.active .thumbnail-marker {
    visibility: visible;
    opacity: 1;
  }

  /* Horizontal scrolling with snap */
  #variantImagesContainer {
    display: flex;
    flex-wrap: nowrap;
    scroll-snap-type: x mandatory;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  #variantImagesContainer > div {
    scroll-snap-align: center;
    flex: 0 0 auto; 
  }
</style>

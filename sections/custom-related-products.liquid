<section class="tabs-section x-py-[32px] md:x-py-[40px]">
    <div class="x-max-w-[1440px] x-mx-auto md:x-px-[50px]">
        <!-- Tab Headers -->
        <div class="tabs x-flex x-flex-row x-gap-[32px] x-justify-center">
            <button class="tab-button current x-text-[16px]" data-tab="related-products" checked>Related Products</button>
            <button class="tab-button x-text-[16px]" data-tab="recently-viewed">Recently Viewed</button>
        </div>
        <!-- Tab Content -->
        <div class="tab-content x-flex x-overflow-auto">
            <!-- Related Products -->
            <div class="tab-pane active" id="related-products">
                <!-- Shopify Recommendations -->
                <div class="product-recommendations"
                    data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=4&intent=related">
                    {%- if recommendations.performed and recommendations.products_count > 0 -%}
                        <div class="x-w-full md:x-grid x-flex md:x-grid-cols-3 lg:x-grid-cols-5 x-flex-row x-overflow-x-auto x-snap-x x-snap-mandatory x-overflow-hidden no-scrollbar">
                            {%- for product in recommendations.products -%}

                            {%- endfor -%}
                        </div>
                    {%- endif -%}
                </div>
            </div>
            <!-- Recently Viewed -->
            <div class="tab-pane x-hidden" id="recently-viewed">
                <div class="x-flex x-flex-row x-flex-wrap x-gap-[16px]" id="recently-viewed-products"></div>
            </div>
        </div>
    </div>
</section>


<script>
    $(document).ready(function () {
        handleTabSwitch();
        console.log(getRecentlyViewedProducts());
        addRecentlyViewedProduct("{{ product.handle }}");
        loadShopifyRecommendations();
    });

    function handleTabSwitch() {
        $('.tab-button').click(function () {
            $('.tab-button').removeClass('current');
            $(this).addClass('current');
        });
    }

    function loadShopifyRecommendations() {
        const productRecommendationsSection = document.querySelector('.product-recommendations');
        const url = productRecommendationsSection.dataset.url;

        if (!url) return;

        fetch(url)
            .then((response) => response.text())
            .then((html) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const recommendations = doc.querySelector('.product-recommendations');

                if (recommendations) {
                    productRecommendationsSection.innerHTML = recommendations.innerHTML;
                } else {
                    productRecommendationsSection.style.display = 'none'; // Hide if no recommendations found
                }
            })
            .catch((e) => {
                console.error('Error loading related products:', e);
            });
    }

    function displayRecentlyViewedProducts() {
        let viewedProducts = getRecentlyViewedProducts();

        if (viewedProducts.length === 0) return;

        $('#recently-viewed').empty();

        viewedProducts.forEach(function (productHandle) {
            $.ajax({
                url: `/products/${productHandle}.js`,
                method: 'GET',
                dataType: 'json',
                success: function (product) {
                    const productHTML = `
                        <a href="/products/${product.handle}" class="recently-viewed-product x-inline-block x-w-[200px] x-mb-[20px]">
                            <img src="${product.featured_image}" class="x-w-full x-h-[100px] md:x-h-[300px]" alt="${product.title}">  
                            <div class="x-text-[14px]">${product.title}</div>
                        </a>
                    `;
                    $('#recently-viewed-products')
                        .append(productHTML)
                        .addClass('x-flex x-gap-[16px] x-overflow-x-auto x-whitespace-nowrap');
                },
                error: function (error) {
                    console.log('Error fetching product data:', error);
                },
            });
        });
    }

    function getRecentlyViewedProducts() {
        let viewedProducts = [];
        let cookie = Cookies.get('recently_viewed_products');
        if (cookie) {
            viewedProducts = JSON.parse(cookie);
        }
        return viewedProducts;
    }

    function addRecentlyViewedProduct(productHandle) {
        let viewedProducts = getRecentlyViewedProducts();
        let index = viewedProducts.indexOf(productHandle);
        if (index > -1) {
            viewedProducts.splice(index, 1);
        }
        viewedProducts.unshift(productHandle);
        Cookies.set('recently_viewed_products', JSON.stringify(viewedProducts), { expires: 30, path: '/' });
    }
</script>

<style>
    .tab-button {
        padding: 10px;
        cursor: pointer;
        border-bottom: 2.5px solid transparent;
        color: rgb(184, 184, 184);
        transition: all 0.3s ease-in-out;
    }

    .tab-button.current {
        border-color: #757575;
        color: inherit;
    }
</style>